<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confidence Intervals Visualization</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        body {
            background-color: #f2f2f2;
            margin: 0;
            padding: 0;
        }
        
        .container {
            margin: 0;
            padding: 0;
            max-width: 100%;
        }
        
        .card {
            background-color: #f2f2f2;
            margin: 0;
            border: none;
        }
        
        .card-body {
            background-color: #f2f2f2;
        }
        
        .card-header {
            background-color: #267326 !important;
            color: white !important;
            border: none;
        }
        
        input[type="range"] {
            accent-color: #267326;
        }
        
        input[type="range"]::-moz-range-thumb {
            background-color: #267326;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            background-color: #267326;
        }
        
        .ci-line {
            height: 3px;
            background-color: #ccc;
            margin: 2px 0;
            position: relative;
        }
        
        .ci-line.contains-mean {
            background-color: #267326;
        }
        
        .ci-line.missed-mean {
            background-color: #d77d00;
        }
        
        .ci-endpoint {
            width: 6px;
            height: 6px;
            background-color: inherit;
            border-radius: 50%;
            position: absolute;
            top: -1.5px;
        }
        
        .sample-mean {
            width: 8px;
            height: 8px;
            background-color: #000;
            border-radius: 50%;
            position: absolute;
            top: -2.5px;
        }
        
        #ci-visualization {
            position: relative;
            height: 400px;
            overflow-y: auto;
            background-color: white;
            border: 1px solid #ddd;
            padding: 10px;
        }
        
        .population-mean-line {
            position: absolute;
            width: 2px;
            height: 100%;
            background-color: #bc1b9a;
            left: 50%;
            top: 0;
            z-index: 10;
        }
        
        .control-btn {
            background-color: #267326;
            border: none;
            color: white;
            padding: 8px 16px;
            margin: 5px;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .control-btn:hover {
            background-color: #1f5c1f;
        }
        
        .stat-box {
            background-color: white;
            padding: 15px;
            margin: 5px 0;
            border-radius: 4px;
        }
        
        .value-display {
            font-weight: bold;
            color: #267326;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">95% Confidence Intervals</div>
                    <div class="card-body">
                        <div id="ci-visualization">
                            <div class="population-mean-line" id="popMeanLine"></div>
                        </div>
                        <div class="mt-3 text-center">
                            <button class="control-btn" id="decreaseSampleSize">Sample size -</button>
                            <button class="control-btn" id="pauseBtn">Pause</button>
                            <button class="control-btn" id="increaseSampleSize">Sample size +</button>
                        </div>
                        <div class="mt-2 text-center">
                            <label for="speedSlider">Speed: <span id="speedValue" class="value-display">50</span></label>
                            <input type="range" id="speedSlider" min="10" max="200" value="50" class="form-range">
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">Slide me</div>
                    <div class="card-body">
                        <label for="sampleSizeSlider">Sample Size: <span id="sampleSizeValue" class="value-display">25</span></label>
                        <input type="range" id="sampleSizeSlider" min="5" max="100" value="25" class="form-range">
                        
                        <label for="confidenceLevelSlider" class="mt-3">Confidence Level: <span id="confidenceLevelValue" class="value-display">95</span>%</label>
                        <input type="range" id="confidenceLevelSlider" min="80" max="99" value="95" class="form-range">
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">Simulation Statistics</div>
                    <div class="card-body">
                        <div class="stat-box">
                            <div>Samples drawn: <span id="samplesDrawn" class="value-display">0</span></div>
                            <div>μ included: <span id="muIncluded" class="value-display">0</span></div>
                            <div>μ missed: <span id="muMissed" class="value-display">0</span></div>
                            <div>Coverage: <span id="coverage" class="value-display">0.00</span>%</div>
                        </div>
                        <div class="mt-2">
                            <canvas id="coverageChart" style="background-color: white;"></canvas>
                        </div>
                        <div class="mt-2 text-center">
                            <button class="control-btn" id="resetBtn">Reset</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Simulation parameters
        const populationMean = 0;
        const populationSD = 1;
        let sampleSize = 25;
        let confidenceLevel = 0.95;
        let speed = 50;
        let isPaused = false;
        let animationInterval = null;
        
        // Statistics
        let samplesDrawn = 0;
        let muIncluded = 0;
        let muMissed = 0;
        let coverageHistory = [];
        
        // Chart
        let coverageChart = null;
        
        // Helper functions
        function normalRandom(mean = 0, sd = 1) {
            let u1 = Math.random();
            let u2 = Math.random();
            let z0 = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
            return z0 * sd + mean;
        }
        
        function tCritical(df, alpha) {
            // Approximation for t-critical value
            // For large df, approaches z-score
            const zScores = {
                0.80: 1.282,
                0.85: 1.440,
                0.90: 1.645,
                0.95: 1.960,
                0.99: 2.576
            };
            
            if (df > 30) {
                return zScores[confidenceLevel] || 1.96;
            }
            
            // Simple approximation for smaller df
            const z = zScores[confidenceLevel] || 1.96;
            return z * (1 + (z * z + 1) / (4 * df));
        }
        
        function drawSample() {
            const sample = [];
            for (let i = 0; i < sampleSize; i++) {
                sample.push(normalRandom(populationMean, populationSD));
            }
            return sample;
        }
        
        function calculateCI(sample) {
            const n = sample.length;
            const mean = sample.reduce((a, b) => a + b, 0) / n;
            const variance = sample.reduce((sum, x) => sum + Math.pow(x - mean, 2), 0) / (n - 1);
            const sd = Math.sqrt(variance);
            const se = sd / Math.sqrt(n);
            
            const df = n - 1;
            const t = tCritical(df, confidenceLevel);
            
            const marginError = t * se;
            const lowerBound = mean - marginError;
            const upperBound = mean + marginError;
            
            return { mean, lowerBound, upperBound };
        }
        
        function scaleToPixels(value, containerWidth) {
            // Scale from [-4, 4] to pixel coordinates
            const rangeMin = -4;
            const rangeMax = 4;
            const padding = 20;
            const usableWidth = containerWidth - 2 * padding;
            const normalized = (value - rangeMin) / (rangeMax - rangeMin);
            return padding + normalized * usableWidth;
        }
        
        function addCIToVisualization(ci) {
            const vizContainer = document.getElementById('ci-visualization');
            const containerWidth = vizContainer.clientWidth;
            
            const containsMean = ci.lowerBound <= populationMean && ci.upperBound >= populationMean;
            
            const ciLine = document.createElement('div');
            ciLine.className = `ci-line ${containsMean ? 'contains-mean' : 'missed-mean'}`;
            
            const leftPos = scaleToPixels(ci.lowerBound, containerWidth);
            const rightPos = scaleToPixels(ci.upperBound, containerWidth);
            const meanPos = scaleToPixels(ci.mean, containerWidth);
            const width = rightPos - leftPos;
            
            ciLine.style.left = `${leftPos}px`;
            ciLine.style.width = `${width}px`;
            
            // Add endpoints
            const leftEndpoint = document.createElement('div');
            leftEndpoint.className = 'ci-endpoint';
            leftEndpoint.style.left = '0px';
            
            const rightEndpoint = document.createElement('div');
            rightEndpoint.className = 'ci-endpoint';
            rightEndpoint.style.right = '0px';
            
            // Add sample mean
            const sampleMean = document.createElement('div');
            sampleMean.className = 'sample-mean';
            sampleMean.style.left = `${meanPos - leftPos - 4}px`;
            
            ciLine.appendChild(leftEndpoint);
            ciLine.appendChild(rightEndpoint);
            ciLine.appendChild(sampleMean);
            
            vizContainer.insertBefore(ciLine, vizContainer.firstChild.nextSibling);
            
            // Keep only last 50 CIs
            while (vizContainer.children.length > 51) {
                vizContainer.removeChild(vizContainer.lastChild);
            }
            
            return containsMean;
        }
        
        function updateStatistics() {
            document.getElementById('samplesDrawn').textContent = samplesDrawn;
            document.getElementById('muIncluded').textContent = muIncluded;
            document.getElementById('muMissed').textContent = muMissed;
            
            const coverage = samplesDrawn > 0 ? (muIncluded / samplesDrawn * 100).toFixed(2) : 0;
            document.getElementById('coverage').textContent = coverage;
            
            coverageHistory.push(parseFloat(coverage));
            if (coverageHistory.length > 50) {
                coverageHistory.shift();
            }
            
            updateCoverageChart();
        }
        
        function updateCoverageChart() {
            const expectedCoverage = confidenceLevel * 100;
            
            if (!coverageChart) {
                const ctx = document.getElementById('coverageChart').getContext('2d');
                coverageChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: coverageHistory.map((_, i) => i + 1),
                        datasets: [
                            {
                                label: 'Actual Coverage',
                                data: coverageHistory,
                                borderColor: '#267326',
                                backgroundColor: 'rgba(38, 115, 38, 0.1)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Expected Coverage',
                                data: Array(coverageHistory.length).fill(expectedCoverage),
                                borderColor: '#bc1b9a',
                                borderDash: [5, 5],
                                tension: 0,
                                fill: false
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        animation: { duration: 0 },
                        scales: {
                            y: {
                                min: 0,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Coverage (%)'
                                }
                            },
                            x: {
                                display: false
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        }
                    }
                });
            } else {
                coverageChart.data.labels = coverageHistory.map((_, i) => i + 1);
                coverageChart.data.datasets[0].data = coverageHistory;
                coverageChart.data.datasets[1].data = Array(coverageHistory.length).fill(expectedCoverage);
                coverageChart.update('none');
            }
        }
        
        function runSimulation() {
            const sample = drawSample();
            const ci = calculateCI(sample);
            const containsMean = addCIToVisualization(ci);
            
            samplesDrawn++;
            if (containsMean) {
                muIncluded++;
            } else {
                muMissed++;
            }
            
            updateStatistics();
        }
        
        function startAnimation() {
            if (animationInterval) {
                clearInterval(animationInterval);
            }
            
            const delay = 2000 / speed;
            animationInterval = setInterval(() => {
                if (!isPaused) {
                    runSimulation();
                }
            }, delay);
        }
        
        function reset() {
            samplesDrawn = 0;
            muIncluded = 0;
            muMissed = 0;
            coverageHistory = [];
            
            const vizContainer = document.getElementById('ci-visualization');
            while (vizContainer.children.length > 1) {
                vizContainer.removeChild(vizContainer.lastChild);
            }
            
            updateStatistics();
        }
        
        // Event listeners
        document.getElementById('sampleSizeSlider').addEventListener('input', (e) => {
            sampleSize = parseInt(e.target.value);
            document.getElementById('sampleSizeValue').textContent = sampleSize;
        });
        
        document.getElementById('confidenceLevelSlider').addEventListener('input', (e) => {
            confidenceLevel = parseInt(e.target.value) / 100;
            document.getElementById('confidenceLevelValue').textContent = e.target.value;
            if (coverageChart) {
                updateCoverageChart();
            }
        });
        
        document.getElementById('speedSlider').addEventListener('input', (e) => {
            speed = parseInt(e.target.value);
            document.getElementById('speedValue').textContent = speed;
            startAnimation();
        });
        
        document.getElementById('pauseBtn').addEventListener('click', () => {
            isPaused = !isPaused;
            document.getElementById('pauseBtn').textContent = isPaused ? 'Resume' : 'Pause';
        });
        
        document.getElementById('resetBtn').addEventListener('click', reset);
        
        document.getElementById('increaseSampleSize').addEventListener('click', () => {
            if (sampleSize < 100) {
                sampleSize += 5;
                document.getElementById('sampleSizeSlider').value = sampleSize;
                document.getElementById('sampleSizeValue').textContent = sampleSize;
            }
        });
        
        document.getElementById('decreaseSampleSize').addEventListener('click', () => {
            if (sampleSize > 5) {
                sampleSize -= 5;
                document.getElementById('sampleSizeSlider').value = sampleSize;
                document.getElementById('sampleSizeValue').textContent = sampleSize;
            }
        });
        
        // Start animation on load
        startAnimation();
    </script>
</body>
</html>
